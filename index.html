<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lane + Object Map</title>
<style>
body, html { margin:0; padding:0; overflow:hidden; background:#fff; }
#canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
#no-lane {
  position:absolute; top:10px; right:10px; z-index:3;
  width:40px; height:40px; background:rgba(255,0,0,0.8);
  color:white; display:flex; align-items:center; justify-content:center;
  border-radius:5px; font-weight:bold; font-size:20px;
}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="no-lane" style="display:none;">ðŸš«</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
const noLaneIcon = document.getElementById('no-lane');

let video = document.createElement('video');
video.autoplay = true;
video.muted = true;
video.playsInline = true;

// Camera for detection only
navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } })
.then(stream => video.srcObject = stream);

let model;
cocoSsd.load().then(m=>{ model = m; });

// Alarm sound
const beep = new Howl({ src:['https://actions.google.com/sounds/v1/alarms/beep_short.ogg'] });

// Simple lane detection (bottom half of video)
function detectLane(frame){
    let w = frame.width;
    let h = frame.height;
    let regionH = Math.floor(h*0.5);
    let leftX = w/2 - 100, rightX = w/2 + 100;
    let detected = false;

    // simple edge detection: average brightness of left/right region
    let data = frame.data;
    let leftSum = 0, rightSum = 0, leftCount=0, rightCount=0;
    for(let y=h-regionH; y<h; y+=4){
        for(let x=0; x<w; x+=4){
            let i = (y*w + x)*4;
            let brightness = (data[i]+data[i+1]+data[i+2])/3;
            if(x<w/2){
                leftSum += brightness; leftCount++;
            } else {
                rightSum += brightness; rightCount++;
            }
        }
    }
    let leftAvg = leftSum/leftCount;
    let rightAvg = rightSum/rightCount;

    if(leftAvg>120 && rightAvg>120) detected = true;

    // compute lane positions
    let laneLeft = detected ? canvas.width/2 - 100 + (leftAvg-120)/2 : canvas.width/2-150;
    let laneRight = detected ? canvas.width/2 + 100 - (rightAvg-120)/2 : canvas.width/2+150;

    return {detected, laneLeft, laneRight};
}

function drawLane(lane){
    let top = 0, bottom = canvas.height;
    ctx.fillStyle = 'rgba(0,255,0,0.3)';
    ctx.beginPath();
    ctx.moveTo(lane.laneLeft, bottom);
    ctx.lineTo(lane.laneRight, bottom);
    ctx.lineTo(lane.laneRight-(lane.laneRight-lane.laneLeft)*0.2, top);
    ctx.lineTo(lane.laneLeft+(lane.laneRight-lane.laneLeft)*0.2, top);
    ctx.closePath();
    ctx.fill();

    if(!lane.detected){
        noLaneIcon.style.display='flex';
    } else {
        noLaneIcon.style.display='none';
    }
}

// Draw objects
function drawObjects(predictions){
    predictions.forEach(pred=>{
        let x = pred.bbox[0]/video.videoWidth*canvas.width;
        let y = pred.bbox[1]/video.videoHeight*canvas.height;
        let w = pred.bbox[2]/video.videoWidth*canvas.width;
        let h = pred.bbox[3]/video.videoHeight*canvas.height;

        if(pred.class==='car'||pred.class==='truck'){
            ctx.fillStyle='red'; ctx.fillRect(x,y,w,h);
        } else if(pred.class==='dog'||pred.class==='cat'||pred.class==='person'){
            ctx.fillStyle='orange'; ctx.beginPath(); ctx.arc(x+w/2,y+h/2,15,0,Math.PI*2); ctx.fill();
        } else {
            ctx.fillStyle='blue'; ctx.beginPath(); ctx.arc(x+w/2,y+h/2,10,0,Math.PI*2); ctx.fill();
        }

        if(h>100) beep.play();
    });
}

// Main loop
let lastDetection = 0;
const detectionInterval = 200; // 5 FPS for object detection

function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(video.readyState===video.HAVE_ENOUGH_DATA){
        let frame = ctx.getImageData(0,0,canvas.width,canvas.height);
        let lane = detectLane(frame);
        drawLane(lane);

        const now = Date.now();
        if(model && now-lastDetection>detectionInterval){
            lastDetection = now;
            model.detect(video).then(pred=>{
                drawObjects(pred);
            });
        }
    }
    requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
