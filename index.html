<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stable Lane + Object Detector</title>
<style>
body, html { margin:0; padding:0; overflow:hidden; background:black; }
#canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
.ui-overlay {
  position:absolute; top:10px; left:10px; z-index:2;
  background:rgba(255,255,255,0.8); padding:10px; border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,0.3); font-family:sans-serif;
}
#no-lane {
  position:absolute; top:10px; right:10px; z-index:3;
  width:40px; height:40px; background:rgba(255,0,0,0.8);
  color:white; display:flex; align-items:center; justify-content:center;
  border-radius:5px; font-weight:bold; font-size:20px;
}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div class="ui-overlay">
<h3>Lane Detector</h3>
<p>Green road lines follow lanes; cars/animals detected.</p>
</div>
<div id="no-lane" style="display:none;">ðŸš«</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
const noLaneIcon = document.getElementById('no-lane');

let video = document.createElement('video');
video.autoplay = true;
video.muted = true;
video.playsInline = true;

navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } })
.then(stream => video.srcObject = stream);

let model;
cocoSsd.load().then(m=>{ model = m; });

const beep = new Howl({ src:['https://actions.google.com/sounds/v1/alarms/beep_short.ogg'] });

// Simple lane detection
function detectLane(frame){
    let w = frame.width;
    let h = frame.height;
    let regionH = Math.floor(h*0.4); // bottom 40% of frame
    let lanePoints = [];
    const data = frame.data;
    for(let y=h-regionH; y<h; y+=4){
        for(let x=0; x<w; x+=4){
            let i = (y*w + x)*4;
            let r = data[i], g=data[i+1], b=data[i+2];
            let brightness = (r+g+b)/3;
            if(brightness>150){
                lanePoints.push({x:x/w*canvas.width, y:y/h*canvas.height});
            }
        }
    }
    return lanePoints;
}

function drawLaneLines(lanePoints){
    if(lanePoints.length>10){
        noLaneIcon.style.display='none';
        ctx.strokeStyle='rgba(0,255,0,0.5)';
        ctx.lineWidth=6;
        ctx.beginPath();
        for(let i=0;i<lanePoints.length;i++){
            let p = lanePoints[i];
            ctx.lineTo(p.x,p.y);
        }
        ctx.stroke();
    } else {
        noLaneIcon.style.display='flex';
        ctx.strokeStyle='rgba(0,255,0,0.3)';
        ctx.lineWidth=8;
        ctx.beginPath(); ctx.moveTo(canvas.width/2-50,canvas.height); ctx.lineTo(canvas.width/2-50,0); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(canvas.width/2+50,canvas.height); ctx.lineTo(canvas.width/2+50,0); ctx.stroke();
    }
}

// Draw objects
function drawObjects(predictions){
    predictions.forEach(pred=>{
        let scaleX = canvas.width/video.videoWidth;
        let scaleY = canvas.height/video.videoHeight;
        let x = pred.bbox[0]*scaleX;
        let y = pred.bbox[1]*scaleY;
        let w = pred.bbox[2]*scaleX;
        let h = pred.bbox[3]*scaleY;

        if(pred.class==='car'||pred.class==='truck'){
            ctx.fillStyle='red'; ctx.fillRect(x,y,w,h);
        } else if(pred.class==='dog'||pred.class==='cat'||pred.class==='person'){
            ctx.fillStyle='orange'; ctx.beginPath(); ctx.arc(x+w/2,y+h/2,15,0,Math.PI*2); ctx.fill();
        } else {
            ctx.fillStyle='blue'; ctx.beginPath(); ctx.arc(x+w/2,y+h/2,10,0,Math.PI*2); ctx.fill();
        }

        if(h>150) beep.play();
    });
}

let lastDetection = 0;
const detectionInterval = 200; // ms -> 5 FPS object detection

function detectFrame(){
    if(video.readyState!==video.HAVE_ENOUGH_DATA){
        requestAnimationFrame(detectFrame);
        return;
    }

    ctx.drawImage(video,0,0,canvas.width,canvas.height);

    let frame = ctx.getImageData(0,0,canvas.width,canvas.height);
    let lanePoints = detectLane(frame);
    drawLaneLines(lanePoints);

    const now = Date.now();
    if(model && now - lastDetection > detectionInterval){
        lastDetection = now;
        model.detect(video).then(pred=>{
            drawObjects(pred);
            requestAnimationFrame(detectFrame);
        });
    } else requestAnimationFrame(detectFrame);
}
</script>
</body>
</html>
